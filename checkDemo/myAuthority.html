<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>权限管理页面</title>
    <link rel="stylesheet" href="js/eModal/css/modal.css"/>
    <script src="js/jquery-2.1.3.min.js"></script>
    <script src="js/jquery-ui.min.js"></script>
    <script src="js/eModal/eModal.js"></script>

    <script>

        $(function () {
            $("#jdh").draggable();
        })


        /**
         *获取当前时间
         * */
        function  getCurentTime () {

            var now = new Date();

            var year = now.getFullYear();       //年
            var month = now.getMonth() + 1;     //月
            var day = now.getDate();            //日

            var hh = now.getHours();            //时
            var mm = now.getMinutes();          //分

            var clock = year + "-";

            if(month < 10)
                clock += "0";

            clock += month + "-";

            if(day < 10)
                clock += "0";

            clock += day + " ";

            if(hh < 10)
                clock += "0";

            clock += hh + ":";
            if (mm < 10) clock += '0';
            clock += mm;

            return (clock+':00');

        }

        function test(){

            var a = $("#myAuthFrame").load("authBody.html", function (data, status) {

                $("#myAuthFrame").empty();

                eModal.modalDialog(
                        data,
                        function(){
                            /*在这个函数中进行左边标签的修改*/
                        },
                        function(){
                            /*点击确定按钮， 即发送请求 增加权限*/

                            var curTime = getCurentTime();

                            var method = {
//                                'user_name': $("#user_name").val(),
//                                'vp_name': sessionStorage.vp_name_w? sessionStorage.vp_name_w: "gengxiuyu",
//                                'plat_name': sessionStorage.plat_name_w? sessionStorage.plat_name_w: "58",
//                                'biz_name': sessionStorage.biz_name_w? sessionStorage.biz_name_w: "page_detail",
                                'operate': "insert",
                                'confirm_date': curTime,
                                'update_date': curTime,
                                'comment':''
                            };

                            handleZtree(method);

                            /*var zTree_Menu = $.fn.zTree.getZTreeObj("treeDemo");
                            //提示用户没有选？
                            if (!zTree_Menu) return;
                            var checkedNodes = zTree_Menu.getCheckedNodes(true);


                            for (var i = 0, len1 = checkedNodes.length; i < len1; i++) {
                                var level = checkedNodes[i].level,
                                    order = checkedNodes[i].description;

                                if (level == 1) continue;

                                if (checkedNodes[i].children) {
                                    var sec_list = checkedNodes[i].children;
                                    for (var j = 0; j < sec_list.length; j++) {
                                        //之前已有权限不会再发送
                                        if (sec_list[j].checked && !sec_list[j].checkedOld) {
                                            method.first_order = order;
                                            method.second_order = sec_list[j].description;

//                                            console.log(method);
                                            /!*向秀玉姐发送请求，新增权限*!/
                                            /!*$.ajax({
//                                                url: 'http://fvp.58corp.com/user_admin.php',
                                                url: 'http://10.9.17.55:8080/user_admin.php',
                                                type: 'post',
                                                async: true,
                                                data: method,
                                                dataType: 'json',
                                                success: function(data, textStatus) {
                                                    console.log("method: ", method);
                                                }
                                            });*!/

                                        }
                                    }
                                }
                            }*/
                        },
                        function(){
                            console.log("取消, 这个函数写取消事件");
                        },
                        {
                            shade: false,
                            newBtn: {
                                show: true,
                                type: "delete",
                                title: "删除已有权限",
                                clickFunc: function () {

                                    var confirmTip = confirm('确定删除该用户的权限'),
                                            method = {
                                                'operate': 'delete'
                                            };

                                    confirmTip && handleZtree(method);

                                }
                            }
                        }
                )
            });

        }

        function handleZtree (method) {

            var method2 = {};
            $.extend(true, method2, method);


            var zTree_Menu = $.fn.zTree.getZTreeObj("treeDemo");
            if (!zTree_Menu) return;
            var checkedNodes = zTree_Menu.getCheckedNodes();

            method2.user_name = $("#user_name").val();
            method2.vp_name = sessionStorage.vp_name_w? sessionStorage.vp_name_w: "gengxiuyu";
            method2.plat_name = sessionStorage.plat_name_w? sessionStorage.plat_name_w: "58";
            method2.biz_name = sessionStorage.biz_name_w? sessionStorage.biz_name_w: "page_detail";

            var isUpdate = method.operate === "delete"? true: false;

            for (var j = 0; j < checkedNodes.length; j++) {

                (function (i) {
                    var level = checkedNodes[i].level;

                    /*1级节点处理方式*/
                    if (level == 0) {
//                        continue;
                        /*一级节点处理方式*/
                        /*if (checkedNodes[i].children) {
                         var sec_list = checkedNodes[i].children;

                         if (isUpdate) {
                         checkedNodes[i].checked = false;
                         checkedNodes[i].checkedOld = false;
                         zTree_Menu.updateNode(checkedNodes[i]);
                         }

                         method.first_order = order;

                         var secStr = "";
                         for (var j = 0; j < sec_list.length; j++) {
                         //不是之前已有权限不会发送删除命令
                         //                        if (sec_list[j].checked && isUpdate) {
                         if (isUpdate) {
                         if (sec_list[j].checked && sec_list[j].checkedOld) {
                         secStr += sec_list[j].description + ",";
                         sec_list[j].checked = false;
                         sec_list[j].checkedOld = false;
                         zTree_Menu.updateNode(sec_list[j]);
                         }
                         } else {
                         if (sec_list[j].checked && !sec_list[j].checkedOld) {
                         //                                method.first_order = order;
                         //                                method.second_order = sec_list[j].description;
                         secStr += sec_list[j].description + ",";
                         }
                         }

                         }
                         if (secStr) {
                         method.second_order = secStr.substring(0, secStr.length - 1);
                         } else {
                         continue;
                         }
                         }*/
                    } else {

                        var method3 = {},
                            order,
                            parNode;

                        if (isUpdate) {
                            if (checkedNodes[i].checked && checkedNodes[i].checkedOld) {
                                order = checkedNodes[i].description;
                                parNode = checkedNodes[i].getParentNode();


                                method3.first_order = parNode.description;
                                method3.second_order = order;

                                $.extend(true, method3, method2);

                                console.log(method3);

                                checkedNodes[i].checked = false;
                                checkedNodes[i].checkedOld = false;
                                zTree_Menu.updateNode(checkedNodes[i]);

                            }
                        } else {
                            if (checkedNodes[i].checked && !checkedNodes[i].checkedOld) {
                                order = checkedNodes[i].description;
                                parNode = checkedNodes[i].getParentNode();


                                method3.first_order = parNode.description;
                                method3.second_order = order;

                                $.extend(true, method3, method2);

                                console.log(method3);

                            }
                        }



                        /*向秀玉姐发送请求，批量删除权限*/
                        /* $.ajax({
                         //                                 url: 'http://fvp.58corp.com/user_admin.php',
                         //                                 url: 'http://10.9.17.55:8080/user_admin.php',
                         type: 'post',
                         async: true,
                         data: method3,
                         dataType: 'json',
                         success: function(data, textStatus) {
                         console.log("method: ", method);
                         }
                         });*/

                    }
                })(j);
            }
        }
    </script>
</head>
<body>
    <div id="myAuthFrame" style="display: none"></div>


    <button onclick="test()">click</button>

<!--<div id="jdh" style="width: 300px; height: 300px; background: red;">xckskadk</div>-->
</body>
</html>