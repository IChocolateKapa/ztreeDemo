<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>权限管理页面</title>
    <link rel="stylesheet" href="js/eModal/css/modal.css"/>
    <script src="js/jquery-2.1.3.min.js"></script>
    <script src="js/jquery-ui.min.js"></script>
    <script src="js/eModal/eModal.js"></script>

    <script>

        $(function () {
            $("#jdh").draggable();
        })


        /**
         *获取当前时间
         * */
        function  getCurentTime () {

            var now = new Date();

            var year = now.getFullYear();       //年
            var month = now.getMonth() + 1;     //月
            var day = now.getDate();            //日

            var hh = now.getHours();            //时
            var mm = now.getMinutes();          //分

            var clock = year + "-";

            if(month < 10)
                clock += "0";

            clock += month + "-";

            if(day < 10)
                clock += "0";

            clock += day + " ";

            if(hh < 10)
                clock += "0";

            clock += hh + ":";
            if (mm < 10) clock += '0';
            clock += mm;

            return (clock+':00');

        }

        var curTime = getCurentTime();

        var method = {
            'operate': "insert",
            'confirm_date': curTime,
            'update_date': curTime,
            //'is_enable': 0,
            'comment':''
        };
//        var method = {};
        function test(){

            var a = $("#myAuthFrame").load("authBody.html", function (data, status) {
                $("#myAuthFrame").empty();
                eModal.modalDialog(
                        data,
                        function(){
                            /*在这个函数中进行左边标签的修改*/
                        },
                        function(){

                            method.user_name = $("#user_name").val();
                            method.vp_name = sessionStorage.vp_name_w? sessionStorage.vp_name_w: "gengxiuyu";
                            method.plat_name = sessionStorage.plat_name_w? sessionStorage.plat_name_w: "58";
                            method.biz_name = sessionStorage.biz_name_w? sessionStorage.biz_name_w: "page_detail";

                            var zTree_Menu = $.fn.zTree.getZTreeObj("treeDemo");
                            //提示用户没有选？
                            if (!zTree_Menu) return;
                            var checkedNodes = zTree_Menu.getCheckedNodes(true);

                            console.log(zTree_Menu.getChangeCheckedNodes());//可以拿到更改过checked状态值的选项， 那就可以实现删除已有权限


                            for (var i = 0, len1 = checkedNodes.length; i < len1; i++) {
                                var level = checkedNodes[i].level,
                                    order = checkedNodes[i].description;

                                if (level == 1) continue;

                                if (checkedNodes[i].children) {
                                    var sec_list = checkedNodes[i].children;
                                    for (var j = 0; j < sec_list.length; j++) {
                                        //之前已有权限不会再发送
                                        if (sec_list[j].checked && !sec_list[j].checkedOld) {
                                            method.first_order = order;
                                            method.second_order = sec_list[j].description;

//                                            console.log(method);
                                            /*向秀玉姐发送请求，新增权限*/
                                            /*$.ajax({
//                                                url: 'http://fvp.58corp.com/user_admin.php',
                                                url: 'http://10.9.17.55:8080/user_admin.php',
                                                type: 'post',
                                                async: true,
                                                data: method,
                                                dataType: 'json',
                                                success: function(data, textStatus) {
                                                    console.log("method: ", method);
                                                }
                                            });*/

                                        }
                                    }
                                }
                            }
                        },
                        function(){
                            console.log("取消, 这个函数写取消事件");
                        },
                        {
                            shade: false,
                            newBtn: {
                                show: true,
                                type: "delete",
                                title: "删除已有权限",
                                clickFunc: function () {


                                    var zTree_Menu = $.fn.zTree.getZTreeObj("treeDemo");
                                    if (!zTree_Menu) return;
                                    var checkedNodes = zTree_Menu.getCheckedNodes(true);

                                    var confirmTip = confirm('确定删除该用户的权限'),
                                        method = {
                                            'operate': 'delete'
                                        };

                                    method.user_name = $("#user_name").val();
                                    method.vp_name = sessionStorage.vp_name_w? sessionStorage.vp_name_w: "gengxiuyu";
                                    method.plat_name = sessionStorage.plat_name_w? sessionStorage.plat_name_w: "58";
                                    method.biz_name = sessionStorage.biz_name_w? sessionStorage.biz_name_w: "page_detail";

                                    for (var i = 0, len1 = checkedNodes.length; i < len1; i++) {
                                        var level = checkedNodes[i].level,
                                            order = checkedNodes[i].description;

                                        if (level == 1) continue;

                                        if (checkedNodes[i].children) {
                                            var sec_list = checkedNodes[i].children;
                                            for (var j = 0; j < sec_list.length; j++) {
                                                //不是之前已有权限不会发送删除命令
                                                if (sec_list[j].checked && !sec_list[j].checkedOld) {
                                                    method.first_order = order;
                                                    method.second_order = sec_list[j].description;

                                                    console.log(method);
                                                    /*向秀玉姐发送请求，删除权限*/
                                                    /*$.ajax({
                                                     //url: 'http://fvp.58corp.com/user_admin.php',
                                                     url: 'http://10.9.17.55:8080/user_admin.php',
                                                     type: 'post',
                                                     async: true,
                                                     data: method,
                                                     dataType: 'json',
                                                     success: function(data, textStatus) {
                                                     console.log("method: ", method);
                                                     }
                                                     });*/

                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                )
            });

        }
    </script>
</head>
<body>
    <div id="myAuthFrame" style="display: none"></div>


    <button onclick="test()">click</button>

<!--<div id="jdh" style="width: 300px; height: 300px; background: red;">xckskadk</div>-->
</body>
</html>